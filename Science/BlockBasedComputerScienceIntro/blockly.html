<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <script src="https://blockly-demo.appspot.com/static/blockly_compressed.js"></script>
  <script src="https://blockly-demo.appspot.com/static/blocks_compressed.js"></script>
  <script src="https://blockly-demo.appspot.com/static/python_compressed.js"></script>
  <script src="https://blockly-demo.appspot.com/static/javascript_compressed.js"></script>
  <script src="https://blockly-demo.appspot.com/static/msg/js/en.js"></script>
  <style>
    body {
      background-color: #fff;
      font-family: sans-serif;
    }
  </style>
</head>
<body>
    <div>
        <button onclick="runCode()">Run Code</button>
        <button onclick="clearOutput()">Clear Output</button>
      </div>

  <div id="blocklyDiv" style="height: 520px; width: 780px;"></div>

  <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display:none">
      <category name="Logic" colour="%{BKY_LOGIC_HUE}">
        <block type="controls_if"></block>
        <block type="logic_compare"></block>
        <block type="logic_operation"></block>
        <block type="logic_negate"></block>
        <block type="logic_boolean"></block>
        <block type="logic_null"></block>
        <block type="logic_ternary"></block>
      </category>
      <category name="Loops" colour="%{BKY_LOOPS_HUE}">
        <block type="controls_repeat_ext">
          <value name="TIMES">
            <shadow type="math_number">
              <field name="NUM">10</field>
            </shadow>
          </value>
        </block>
        <block type="controls_whileUntil"></block>
        <block type="controls_for">
          <value name="FROM">
            <shadow type="math_number">
              <field name="NUM">1</field>
            </shadow>
          </value>
          <value name="TO">
            <shadow type="math_number">
              <field name="NUM">10</field>
            </shadow>
          </value>
          <value name="BY">
            <shadow type="math_number">
              <field name="NUM">1</field>
            </shadow>
          </value>
        </block>
        <block type="controls_forEach"></block>
        <block type="controls_flow_statements"></block>
      </category>
      <category name="Math" colour="%{BKY_MATH_HUE}">
        <block type="math_number">
          <field name="NUM">123</field>
        </block>
        <block type="math_arithmetic">
          <value name="A">
            <shadow type="math_number">
              <field name="NUM">1</field>
            </shadow>
          </value>
          <value name="B">
            <shadow type="math_number">
              <field name="NUM">1</field>
            </shadow>
          </value>
        </block>
        <block type="math_single">
          <value name="NUM">
            <shadow type="math_number">
              <field name="NUM">9</field>
            </shadow>
          </value>
        </block>
        <block type="math_trig">
          <value name="NUM">
            <shadow type="math_number">
              <field name="NUM">45</field>
            </shadow>
          </value>
        </block>
        <block type="math_constant"></block>
        <block type="math_number_property">
          <value name="NUMBER_TO_CHECK">
            <shadow type="math_number">
              <field name="NUM">0</field>
            </shadow>
          </value>
        </block>
        <block type="math_round">
          <value name="NUM">
            <shadow type="math_number">
              <field name="NUM">3.1</field>
            </shadow>
          </value>
        </block>
        <block type="math_on_list"></block>
        <block type="math_modulo">
          <value name="DIVIDEND">
            <shadow type="math_number">
              <field name="NUM">64</field>
            </shadow>
          </value>
          <value name="DIVISOR">
            <shadow type="math_number">
              <field name="NUM">10</field>
            </shadow>
          </value>
        </block>
        <block type="math_constrain">
          <value name="VALUE">
            <shadow type="math_number">
              <field name="NUM">50</field>
            </shadow>
          </value>
          <value name="LOW">
            <shadow type="math_number">
              <field name="NUM">1</field>
            </shadow>
          </value>
          <value name="HIGH">
            <shadow type="math_number">
              <field name="NUM">100</field>
            </shadow>
          </value>
        </block>
        <block type="math_random_int">
          <value name="FROM">
            <shadow type="math_number">
              <field name="NUM">1</field>
            </shadow>
          </value>
          <value name="TO">
            <shadow type="math_number">
              <field name="NUM">100</field>
            </shadow>
          </value>
        </block>
        <block type="math_random_float"></block>
        <block type="math_atan2">
          <value name="X">
            <shadow type="math_number">
              <field name="NUM">1</field>
            </shadow>
          </value>
          <value name="Y">
            <shadow type="math_number">
              <field name="NUM">1</field>
            </shadow>
          </value>
        </block>
      </category>
      <category name="Text" colour="%{BKY_TEXTS_HUE}">
        <block type="text"></block>
        <block type="text_join"></block>
        <block type="text_append">
          <value name="TEXT">
            <shadow type="text"></shadow>
          </value>
        </block>
        <block type="text_length">
          <value name="VALUE">
            <shadow type="text">
              <field name="TEXT">abc</field>
            </shadow>
          </value>
        </block>
        <block type="text_isEmpty">
          <value name="VALUE">
            <shadow type="text">
              <field name="TEXT"></field>
            </shadow>
          </value>
        </block>
        <block type="text_indexOf">
          <value name="VALUE">
            <block type="variables_get">
              <field name="VAR">{textVariable}</field>
            </block>
          </value>
          <value name="FIND">
            <shadow type="text">
              <field name="TEXT">abc</field>
            </shadow>
          </value>
        </block>
        <block type="text_charAt">
          <value name="VALUE">
            <block type="variables_get">
              <field name="VAR">{textVariable}</field>
            </block>
          </value>
        </block>
        <block type="text_getSubstring">
          <value name="STRING">
            <block type="variables_get">
              <field name="VAR">{textVariable}</field>
            </block>
          </value>
        </block>
        <block type="text_changeCase">
          <value name="TEXT">
            <shadow type="text">
              <field name="TEXT">abc</field>
            </shadow>
          </value>
        </block>
        <block type="text_trim">
          <value name="TEXT">
            <shadow type="text">
              <field name="TEXT">abc</field>
            </shadow>
          </value>
        </block>
        <block type="text_print">
          <value name="TEXT">
            <shadow type="text">
              <field name="TEXT">abc</field>
            </shadow>
          </value>
        </block>
        <block type="text_prompt_ext">
          <value name="TEXT">
            <shadow type="text">
              <field name="TEXT">abc</field>
            </shadow>
          </value>
        </block>
      </category>
      <category name="Lists" colour="%{BKY_LISTS_HUE}">
        <block type="lists_create_with">
          <mutation items="0"></mutation>
        </block>
        <block type="lists_create_with"></block>
        <block type="lists_repeat">
          <value name="NUM">
            <shadow type="math_number">
              <field name="NUM">5</field>
            </shadow>
          </value>
        </block>
        <block type="lists_length"></block>
        <block type="lists_isEmpty"></block>
        <block type="lists_indexOf">
          <value name="VALUE">
            <block type="variables_get">
              <field name="VAR">{listVariable}</field>
            </block>
          </value>
        </block>
        <block type="lists_getIndex">
          <value name="VALUE">
            <block type="variables_get">
              <field name="VAR">{listVariable}</field>
            </block>
          </value>
        </block>
        <block type="lists_setIndex">
          <value name="LIST">
            <block type="variables_get">
              <field name="VAR">{listVariable}</field>
            </block>
          </value>
        </block>
        <block type="lists_getSublist">
          <value name="LIST">
            <block type="variables_get">
              <field name="VAR">{listVariable}</field>
            </block>
          </value>
        </block>
        <block type="lists_split">
          <value name="DELIM">
            <shadow type="text">
              <field name="TEXT">,</field>
            </shadow>
          </value>
        </block>
        <block type="lists_sort"></block>
      </category>
      <category name="Colours" colour="%{BKY_COLOUR_HUE}">
        <block type="colour_picker"></block>
        <block type="colour_random"></block>
        <block type="colour_rgb">
          <value name="RED">
            <shadow type="math_number">
              <field name="NUM">100</field>
            </shadow>
          </value>
          <value name="GREEN">
            <shadow type="math_number">
              <field name="NUM">50</field>
            </shadow>
          </value>
          <value name="BLUE">
            <shadow type="math_number">
              <field name="NUM">0</field>
            </shadow>
          </value>
        </block>
        <block type="colour_blend">
          <value name="COLOUR1">
            <shadow type="colour_picker">
              <field name="COLOUR">#ff0000</field>
            </shadow>
          </value>
          <value name="COLOUR2">
            <shadow type="colour_picker">
              <field name="COLOUR">#3333ff</field>
            </shadow>
          </value>
          <value name="RATIO">
            <shadow type="math_number">
              <field name="NUM">0.5</field>
            </shadow>
          </value>
        </block>
      </category>
      <sep></sep>
      <category name="Variables" colour="%{BKY_VARIABLES_HUE}" custom="VARIABLE"></category>
      <category name="Functions" colour="%{BKY_PROCEDURES_HUE}" custom="PROCEDURE"></category>
    </xml>

  <table style="width:100%">
    <tr>
      <th style="width:50%">Output</th><th style="width:50%">Python Code</th>
    </tr>
    <tr>
      <td style="vertical-align:top"><div id='remappedOutput'></div></td>
      <td style="vertical-align:top"><pre id='codeDisplay'></pre></td>
    </tr>
  </table>

<script>
  // from https://blockly-demo.appspot.com/static/demos/custom-dialogs/index.html
  CustomDialog = {};
  Blockly.confirm = function(message, callback) {
    console.log('Confirm: ' + message);
    CustomDialog.show('Confirm', message, {
      showOkay: true,
      onOkay: function() {
        callback(true);
      },
      showCancel: true,
      onCancel: function() {
        callback(false);
      }
    });
  };
  Blockly.prompt = function(message, defaultValue, callback) {
    console.log('Prompt: ' + message);
    CustomDialog.show('Prompt', message, {
      showInput: true,
      showOkay: true,
      onOkay: function() {
        callback(CustomDialog.inputField.value);
      },
      showCancel: true,
      onCancel: function() {
        callback(null);
      }
    });
    CustomDialog.inputField.value = defaultValue;
  };
  CustomDialog.hide = function() {
    if (CustomDialog.backdropDiv_) {
      CustomDialog.backdropDiv_.style.display = 'none';
      CustomDialog.dialogDiv_.style.display = 'none';
    }
  };
  CustomDialog.show = function(title, message, options) {
    var backdropDiv = CustomDialog.backdropDiv_;
    var dialogDiv = CustomDialog.dialogDiv_;
    if (!dialogDiv) {
      backdropDiv = document.createElement('div');
      backdropDiv.id = 'customDialogBackdrop';
      backdropDiv.style.cssText =
          'position: absolute;' +
          'top: 0; left: 0; right: 0; bottom: 0;' +
          'background-color: rgba(0, 0, 0, .7);' +
          'z-index: 100;';
      document.body.appendChild(backdropDiv);
      dialogDiv = document.createElement('div');
      dialogDiv.id = 'customDialog';
      dialogDiv.style.cssText =
          'background-color: #fff;' +
          'width: 400px;' +
          'margin: 20px auto 0;' +
          'padding: 10px;';
      backdropDiv.appendChild(dialogDiv);

      dialogDiv.onclick = function(event) {
        event.stopPropagation();
      };
      CustomDialog.backdropDiv_ = backdropDiv;
      CustomDialog.dialogDiv_ = dialogDiv;
    }
    backdropDiv.style.display = 'block';
    dialogDiv.style.display = 'block';
    dialogDiv.innerHTML =
        '<header class="customDialogTitle"></header>' +
        '<p class="customDialogMessage"></p>' +
        (options.showInput ? '<div><input id="customDialogInput"></div>' : '') +
        '<div class="customDialogButtons">' +
        (options.showCancel ? '<button id="customDialogCancel">Cancel</button>': '') +
        (options.showOkay ? '<button id="customDialogOkay">OK</button>': '') +
        '</div>';
    dialogDiv.getElementsByClassName('customDialogTitle')[0]
        .appendChild(document.createTextNode(title));
    dialogDiv.getElementsByClassName('customDialogMessage')[0]
        .appendChild(document.createTextNode(message));
    var onOkay = function(event) {
      CustomDialog.hide();
      options.onOkay && options.onOkay();
      event && event.stopPropagation();
    };
    var onCancel = function(event) {
      CustomDialog.hide();
      options.onCancel && options.onCancel();
      event && event.stopPropagation();
    };
    var dialogInput = document.getElementById('customDialogInput');
    CustomDialog.inputField = dialogInput;
    if (dialogInput) {
      dialogInput.focus();
      dialogInput.onkeyup = function(event) {
        if (event.keyCode == 13) { // enter
          onOkay();
          return false;
        } else if (event.keyCode == 27)  { // esc
          onCancel();
          return false;
        }
      };
    } else {
      var okay = document.getElementById('customDialogOkay');
      okay && okay.focus();
    }
    if (options.showOkay) {
      document.getElementById('customDialogOkay')
          .addEventListener('click', onOkay);
    }
    if (options.showCancel) {
      document.getElementById('customDialogCancel')
          .addEventListener('click', onCancel);
    }
    backdropDiv.onclick = onCancel;
    };

  // move window.alert because it won't work in an iframe
  function remapAlert(messageString) {
    var previousOutput = document.getElementById('remappedOutput').innerText;
    document.getElementById('remappedOutput').innerText = previousOutput + '\n' + messageString;
  }
  window.alert = remapAlert;

  function clearOutput() {
    document.getElementById('remappedOutput').innerText = '';
  }

  var workspace = Blockly.inject('blocklyDiv', {media: 'https://unpkg.com/blockly/media/', toolbox: document.getElementById('toolbox')});

  function showCode() {
    Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
    var code = Blockly.Python.workspaceToCode(workspace);
    document.getElementById('codeDisplay').innerText = code;
  }

  function runCode() {
    window.LoopTrap = 1000;
    Blockly.JavaScript.INFINITE_LOOP_TRAP = 'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';
    var code = Blockly.JavaScript.workspaceToCode(workspace);
    Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
    try {
      eval(code);
    } catch(e) {
      alert(e);
    }
  }

  workspace.addChangeListener(showCode);
</script>

</body>
</html>